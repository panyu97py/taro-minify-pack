# @taro-minify-pack/plugin-async-pack

å¼‚æ­¥åŠ è½½ä¸»åŒ…ä»£ç ï¼Œä¼˜åŒ–ä¸»åŒ…ä½“ç§¯ï¼ˆä»…åŒ…å«å¼‚æ­¥æ¨¡å—`js`æ–‡ä»¶ï¼‰

## âœ¨ åŠŸèƒ½ç‰¹æ€§

- **ä¸»åŒ…ä½“ç§¯ä¼˜åŒ–**ï¼šå°†åŠ¨æ€å¯¼å…¥çš„æ¨¡å—è‡ªåŠ¨æ‹†åˆ†åˆ°å¼‚æ­¥åˆ†åŒ…ï¼Œæœ‰æ•ˆå‡å°‘ä¸»åŒ…ä½“ç§¯
- **çµæ´»é…ç½®**ï¼šå¯è‡ªå®šä¹‰å¼‚æ­¥åˆ†åŒ…åç§°å‰ç¼€å’Œæ•°é‡
- **è‡ªåŠ¨åŒ–å¤„ç†**ï¼šè‡ªåŠ¨ä¿®æ”¹å°ç¨‹åºé…ç½®æ–‡ä»¶ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ
- **æ€§èƒ½æå‡**ï¼šå‡å°‘å°ç¨‹åºå¯åŠ¨æ—¶é—´ï¼Œæå‡ç”¨æˆ·ä½“éªŒ

## ğŸ“¦ å®‰è£…

```bash
npm install @taro-minify-pack/plugin-async-pack
```

### yarn å®‰è£…
```bash
yarn add @taro-minify-pack/plugin-async-pack
```

### pnpm å®‰è£…
```bash
pnpm add @taro-minify-pack/plugin-async-pack
```

## âš™ï¸ é…ç½®

### `babel`é…ç½®
```ts
// babel-preset-taro æ›´å¤šé€‰é¡¹å’Œé»˜è®¤å€¼ï¼š
// https://docs.taro.zone/docs/next/babel-config
module.exports = {
    presets: [
        ['taro', {
            framework: 'react',
            ts: true,
            compiler: 'webpack5',
            // åœ¨åŸæœ‰åŸºç¡€ä¸Šæ·»åŠ è¿™ä¸ªé…ç½®å³å¯
            'dynamic-import-node': process.env.TARO_ENV !== 'weapp', 
        }]
    ]
}
```

### `Taro` é…ç½®
```js
// config/index.js
module.exports = {
    compiler: {
        type: 'webpack5',
        prebundle: {
            // å…³é—­é¢„æ‰“åŒ…,è¿™é‡Œå’Œåˆ†åŒ…å¼‚æ­¥ç¼–è¯‘æœ‰å†²çª
            enable: false,
        }
    },
    plugins: [
        ['@taro-minify-pack/plugin-async-pack', {
            // å¼‚æ­¥åˆ†åŒ…åå‰ç¼€ï¼Œé»˜è®¤ä¸º 'dynamic-common'
            dynamicPackageNamePrefix: 'dynamic-common',
            // å¼‚æ­¥åˆ†åŒ…æ•°é‡ï¼Œé»˜è®¤ä¸º 1
            dynamicPackageCount: 2
        }],
    ],
};
```

## ğŸš€ ä½¿ç”¨

### åŸºæœ¬ä½¿ç”¨
```ts
// åŠ¨æ€å¯¼å…¥æ¨¡å—
const module = await import('./dynamic-module')
```

### React ç»„ä»¶æ‡’åŠ è½½
```tsx
import { lazy, Suspense } from 'react'

const DynamicComponent = lazy(() => import('./DynamicComponent'))

function App() {
  return (
    <Suspense fallback={<div>Loading...</div>}>
      <DynamicComponent />
    </Suspense>
  )
}
```

### Vue ç»„ä»¶æ‡’åŠ è½½
```vue
<template>
  <view class="index">
    <Suspense>
      <template #default>
         <AsyncComponent/>
      </template>
      <template #fallback>
        <view>loading...</view>
      </template>
    </Suspense>
  </view>
</template>

<script setup>
import {defineAsyncComponent, ref} from 'vue'
const AsyncComponent = defineAsyncComponent(() => import('./async-component')
)
</script>
```

## ğŸ“ å·¥ä½œåŸç†

1. **Webpack é…ç½®ä¿®æ”¹**ï¼š
   - è¦†ç›– `splitChunks` è§„åˆ™ï¼Œä½¿`common`ä¸`vendors`åªå¤„ç†åŒæ­¥æ¨¡å—
   - é…ç½® `chunkFilename` ç”Ÿæˆè§„åˆ™ï¼Œç¡®ä¿å¼‚æ­¥æ¨¡å—æ­£ç¡®è¾“å‡ºåˆ°æŒ‡å®šåˆ†åŒ…
   - ä¿®æ”¹ `miniCssExtractPlugin` é…ç½®ï¼Œç¡®ä¿å¼‚æ­¥æ¨¡å—çš„æ ·å¼æ–‡ä»¶ä¹Ÿèƒ½æ­£ç¡®æ‹†åˆ†åˆ°æŒ‡å®šç›®å½•
   - ä¿®æ”¹ `runtime.js` è¾“å‡ºï¼Œç¡®ä¿å¼‚æ­¥æ¨¡å—çš„`js`æ–‡ä»¶èƒ½é€šè¿‡`require.async`æ­£ç¡®å¼•å…¥

2. **æ ·å¼å¤„ç†**ï¼š
   - ä¸ºæ¯ä¸ªå¼‚æ­¥åˆ†åŒ…ç”Ÿæˆæ ·å¼ç»„ä»¶
   - è‡ªåŠ¨æ”¶é›†è¯¥åˆ†åŒ…ä¸‹çš„æ‰€æœ‰æ ·å¼æ–‡ä»¶å¹¶é€šè¿‡ `@import` å¼•å…¥ä¸»åŒ…`app.wxss`åŒæ­¥å¼•å…¥

3. **å°ç¨‹åºé…ç½®ä¿®æ”¹**ï¼š
   - è‡ªåŠ¨ä¿®æ”¹ `app.json`ï¼Œæ·»åŠ å¼‚æ­¥åˆ†åŒ…é…ç½®

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ä»…æ”¯æŒå¾®ä¿¡å°ç¨‹åº**ï¼šå½“å‰æ’ä»¶ä»…é€‚ç”¨äºå¾®ä¿¡å°ç¨‹åºç¯å¢ƒ
2. **å…³é—­é¢„æ‰“åŒ…**ï¼šå¿…é¡»å…³é—­ Taro çš„é¢„æ‰“åŒ…åŠŸèƒ½ï¼Œå¦åˆ™å¯èƒ½ä¸å¼‚æ­¥åˆ†åŒ…åŠŸèƒ½å†²çª
3. **Babel é…ç½®**ï¼šéœ€è¦æ­£ç¡®é…ç½® Babel çš„ `dynamic-import-node` é€‰é¡¹
4. **Webpack ç‰ˆæœ¬**ï¼šä»…æ”¯æŒ Webpack 5 ç¼–è¯‘å™¨
5. **åˆ†åŒ…æ•°é‡**ï¼šæ ¹æ®é¡¹ç›®å®é™…æƒ…å†µé…ç½® `dynamicPackageCount`ï¼Œè¿‡å¤šçš„åˆ†åŒ…å¯èƒ½ä¼šå½±å“æ€§èƒ½
6. **ç‰ˆæœ¬è¦æ±‚**ï¼šæ’ä»¶ç‰ˆæœ¬`0.0.5-alpha.x`å°è¯•å®ç°æ ·å¼æ–‡ä»¶å¼‚æ­¥åŠ è½½å—å¾®ä¿¡æœºåˆ¶å½±å“å­˜åœ¨æ— æ³•ä¼˜åŒ–çš„ã€Œé—ªå±æ ·å¼ä¸¢å¤±ã€,æ•…`0.0.5`åŠä»¥åç‰ˆæœ¬ä¸æ”¯æŒæ ·å¼æ–‡ä»¶å¼‚æ­¥åŠ è½½ã€‚

## ğŸ”§ é…ç½®é€‰é¡¹

| é€‰é¡¹å                        | ç±»å‹       | é»˜è®¤å€¼                | æè¿°       |
|----------------------------|----------|--------------------|----------|
| `dynamicPackageNamePrefix` | `string` | `'dynamic-common'` | å¼‚æ­¥åˆ†åŒ…åç§°å‰ç¼€ |
| `dynamicPackageCount`      | `number` | `1`                | å¼‚æ­¥åˆ†åŒ…æ•°é‡   |

## ğŸ¤ å¸¸è§é—®é¢˜

### 1. å¼‚æ­¥æ¨¡å—æ²¡æœ‰è¢«æ‹†åˆ†åˆ°åˆ†åŒ…ï¼Ÿ
- è¯·æ£€æŸ¥æ˜¯å¦æ­£ç¡®é…ç½®äº† `dynamic-import-node` é€‰é¡¹
- ç¡®ä¿å·²å…³é—­ Taro çš„é¢„æ‰“åŒ…åŠŸèƒ½
- ç¡®è®¤ä½¿ç”¨äº† Webpack 5 ç¼–è¯‘å™¨
- ç¡®ä¿ä»£ç ä¸­ä½¿ç”¨äº† `import()` åŠ¨æ€å¯¼å…¥è¯­æ³•

### 2. å¼‚æ­¥ç»„ä»¶çš„æ ·å¼æ²¡æœ‰åŠ è½½ï¼Ÿ
- æ£€æŸ¥æ˜¯å¦æœ‰ç¼–è¯‘é”™è¯¯æˆ–è­¦å‘Šä¿¡æ¯

### 3. é…ç½®åç¼–è¯‘å¤±è´¥ï¼Ÿ
- è¯·æ£€æŸ¥é…ç½®é€‰é¡¹æ˜¯å¦æ­£ç¡®
- ç¡®è®¤ Taro ç‰ˆæœ¬ä¸æ’ä»¶ç‰ˆæœ¬å…¼å®¹
- æŸ¥çœ‹ç¼–è¯‘æ—¥å¿—ï¼Œæ’æŸ¥å…·ä½“é”™è¯¯åŸå› 

### 4. é¡µé¢åŠ è½½æ—¶å‡ºç°ç™½å±ï¼Ÿ
- è¯·æ£€æŸ¥æ˜¯å¦æ­£ç¡®ä½¿ç”¨äº† `Suspense` ç»„ä»¶åŒ…è£¹å¼‚æ­¥ç»„ä»¶
- ç¡®ä¿å¼‚æ­¥ç»„ä»¶çš„å¯¼å…¥è·¯å¾„æ­£ç¡®
- æ£€æŸ¥ç½‘ç»œè¯·æ±‚æ˜¯å¦æ­£å¸¸

### 5. åˆ†åŒ…æ•°é‡é…ç½®åæ²¡æœ‰ç”Ÿæ•ˆï¼Ÿ
- è¯·ç¡®ä¿ `dynamicPackageCount` é…ç½®çš„å€¼å¤§äº0
- æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„åŠ¨æ€å¯¼å…¥æ¨¡å—æ¥æ‹†åˆ†åˆ°å¤šä¸ªåˆ†åŒ…

## ğŸ“„ è®¸å¯è¯

MIT License

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

> è¯¥æ’ä»¶æ˜¯ @taro-minify-pack ç³»åˆ—æ’ä»¶çš„ä¸€éƒ¨åˆ†ï¼Œè‡´åŠ›äºæä¾›å®Œæ•´çš„ Taro é¡¹ç›®ä¼˜åŒ–è§£å†³æ–¹æ¡ˆã€‚

